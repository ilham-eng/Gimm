name: Server with Serveo SSH Tunnel

on:
  workflow_dispatch:

jobs:
  serveo-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create package.json
      run: |
        echo '{"name":"gimm-server","version":"1.0.0","scripts":{"start":"node server.js"},"dependencies":{"express":"^4.18.2"}}' > package.json
        
    - name: Install dependencies
      run: npm install
        
    - name: Create server.js
      run: |
        cat << "EOF" > server.js
        const express = require('express');
        const app = express();
        const PORT = 3000;
        app.use(express.json());
        let visitors = 0;
        app.get('/', (req, res) => {
          visitors++;
          res.json({
            message: 'ğŸš€ Server with SSH Tunnel!',
            visitors: visitors,
            timestamp: new Date().toISOString(),
            public_url: process.env.SERVEO_URL || 'http://localhost:3000'
          });
        });
        app.listen(PORT, () => {
          console.log('Server running on port ' + PORT);
        });
        EOF
        
    - name: Setup SSH tunnel with Serveo
      run: |
        echo "ğŸ”— Setting up SSH tunnel with Serveo..."
        ssh -o StrictHostKeyChecking=no -R 80:localhost:3000 serveo.net 2>&1 | \
        while read line; do
          echo "$line"
          if echo "$line" | grep -q "forwarding"; then
            SERVEO_URL=$(echo "$line" | grep -oE 'https://[a-zA-Z0-9.-]+\.serveo\.net')
            echo "SERVEO_URL=$SERVEO_URL" >> $GITHUB_ENV
            echo "ğŸŒ Public URL: $SERVEO_URL"
          fi
        done &
        TUNNEL_PID=$!
        echo "TUNNEL_PID=$TUNNEL_PID" >> $GITHUB_ENV
        sleep 10
        
    - name: Start server and test
      run: |
        echo "ğŸ”§ Starting server..."
        npm start &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        sleep 5
        
        if [ -n "$SERVEO_URL" ]; then
          echo "ğŸ§ª Testing via Serveo..."
          curl -f "$SERVEO_URL" || echo "Serveo test failed"
        else
          echo "ğŸ§ª Testing via localhost..."
          curl -f http://localhost:3000
        fi
        
    - name: Display URLs
      run: |
        echo "ğŸ‰ ================================="
        echo "ğŸ‰ SERVER DEPLOYMENT COMPLETE!"
        echo "ğŸ‰ ================================="
        if [ -n "$SERVEO_URL" ]; then
          echo "ğŸŒ Serveo URL: $SERVEO_URL"
        fi
        echo "ğŸ”— Local URL: http://localhost:3000"
        echo "â° Server will run for 1 hour"
        echo "ğŸ‰ ================================="
        
    - name: Keep alive
      run: sleep 3600
